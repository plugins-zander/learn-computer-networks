# 传输层

6.1.1 传输层的作用

从通信和信息处理的角度看，运输层向应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层。 



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203081001.png)

6.1.2 传输层的功能

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203081109.png)



传输层的主要功能

（1）传输层为应用**进程之间**提供端到端的逻辑通信（但网络层是为主机之间提供逻辑通信）。

（2）传输层还要对收到的报文进行**差错检测。**

（3）传输层需要有两种不同的运输协议，即面向连接的 TCP 和无连接的 UDP。

> tcp打电话两边连接一起通才行，udp写信给别人，可能地址已经变了，就寄不到了

传输层向上提供可靠的和不可靠的逻辑通信信道

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203081520.png)

## 6.2 TCP／IP的传输层

### 6.2.1 TCP与UDP

TCP/IP 的传输层有两个不同的协议

（1）**用户数据报协议** UDP（User Datagram Protocol）

（2）**传输控制协议** TCP（Transmission Control Protocol）

两个对等运输实体在通信时传送的数据单位叫作**运输协议数据单元 TPDU** (Transport Protocol Data Unit)。

> 往上都是协议加pdu

TCP 传送的数据单位协议是 TCP 报文段(segment) 

UDP 传送的数据单位协议是 UDP 报文或用户数据报。

UDP 在传送数据之前不需要先建立连接。对方的运输层在收到 UDP 报文后，不需要给出任何确认。虽然 UDP 不提供可靠交付，但在某些情况下 UDP 是一种最有效的工作方式。

> 是否发出只能依赖应用层，而不是下面层
>
> 网络通畅情况下，效率较高

TCP 则提供面向连接的服务。TCP 不提供广播或多播服务。由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销。这不仅使TCP报文的首部增大很多，还要占用许多的处理机资源。  

运输层的 UDP 用户数据报与网际层的IP数据报有很大区别。IP 数据报要经过互连网中许多路由器的存储转发，但 UDP 用户数据报是在运输层的端到端抽象的逻辑信道中传送的。

> 不论是tcp还是udp数据报，最终下一步还是要封装为ip数据报

TCP 报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道。但这样的信道却不知道究竟经过了哪些路由器（分层屏蔽了下层功能），而这些路由器也根本不知道上面的运输层是否建立了 TCP 连接。 







### 6.2.2 传输层的端口



从操作系统的角度来看，运行在计算机中的应用进程是用进程标识符来标识的。但传输层的实体却无法使用进程标识符来标识应用进程。

为了使运行不同操作系统的计算机的应用进程能够互相通信，必须用统一的方法对 TCP/IP 体系的应用进程进行标识。解决方法就是在传输层使用协议端口号(protocol port number)，或通常简称为端口(port)

> 比如mysql端口是3306

端口就是运输层服务访问点 TSAP。

端口的作用就是让应用层的各种应用进程都能将其数据通过端口向下交付给运输层，以及让运输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。

> 端口被占用，要求更换端口
>
> 不是真的端口，数据报中的一个数据体现

从这个意义上讲，端口是用来标志应用层的进程。 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203084030.png)



端口在进程之间的通信中所起的作用 

>  安装不需要端口号，默认或者系统分配

端口用一个 16 bit 端口号进行标志。

端口号只具有本地意义，即端口号只是为了**标志本计算机应用层中的各进程。在因特网中不同计算机的相同端口号是没有联系的。**

> 到达运输层才有端口作用



三类端口 

熟知端口 (well-known port)。其数值一般为 0~1023。这一类端口由ICANN负责分配给一些常用的应用层程序固定使用。

> 早期的，如http，80,20,21

记端口。数值一般为 1024~49151，由ICANN负责登记，防止重复。

> 3306mysql

动态端口。49152-65535，临时端口。

> 每次使用都是变化的



TCP/IP应用层的一些通用服务协议使用的端口

| 服务                          | 端口 | 协议               |
| ----------------------------- | ---- | ------------------ |
| 文件传输服务                  | 21   | FTP                |
| 远程登录服务                  | 23   | TELNET             |
| 传输邮件服务                  | 25   | SMTP（邮件客户端） |
| 用于万维网(WWW)的文本传输服务 | 80   | HTTP               |
| 访问远程服务器上的邮件服务    | 110  | POP3               |
| 互联网消息存取服务            | 143  | IMAP4              |
| 安全的超文本传输服务          | 443  | HTTPS              |
| 安全的远程登录服务            | 992  | TELNETS            |
| 安全的消息存取服务            | 993  | IMAPS              |

> 可以自定义，上面是默认

端口是用报文队列来实现 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203090415.png)

TCP 把连接作为最基本的抽象。

每一条 TCP 连接有两个端点。

TCP 连接的端点叫做套接字(socket)或插口。

端口号拼接到(contatenated with) IP 地址即构成了套接字。

每一条 TCP 连接唯一地被通信两端的两个端点（即两个套接字）所确定。

```
TCP 连接 ::= {socket1, socket2} = {(IP1: port1), (IP2: port2)} 
```





## 6.3 传输控制协议TCP

6.3.1 TCP协议概述

TCP 是面向连接的运输层协议。采用面向报文段的通信机制

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203090806.png)

> 存储转发

TCP的主要特点 

TCP 是**面向连接**的运输层协议。每一条 TCP 连接只能有两个端点(endpoint)，每一条 TCP 连接只能是**点对点**的（一对一）。 TCP 提供可靠交付的服务。 TCP 提供**全双工**通信。**面向字节流**。  

TCP 面向字节流的概念 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203091302.png)



TCP 连接是一条虚连接而不是一条真正的物理连接。

TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的。

TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。

TCP 可把太长的数据块划分短一些再传送。TCP 也可等待积累有足够多的字节后再构成报文段发送出去。 







### 6.3.2 TCP报文的格式

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191203092003.png)

在指定进程间进行通信



































































































































































































