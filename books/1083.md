# IP路由与路由协议

```
5.5.1 路由与路由器
5.5.2 静态路由与动态路由
5.5.3 RIP路由协议
5.5.4 OSPF路由协议
5.5.5 BGP路由协议
```

### ### 1.路由与路由选择

路由是为了将IP数据报送达目标主机所在的网络而进行的最佳路径的选择。

就是解决“何去何从”的问题。

路由器将所有关于如何到达目标网络的最佳路径信息以数据库表的形式存储起来，这种专门用于存放路由信息的表被称为路由表。

### 2.路由器的功能

（1）实现在网络层的网络互连和路由选择

（2）建立并维护路由表。

（3）路由器可实现网络层及其以下各层的协议转换。

（4）提供网络间的分组转发功能。

### 3.路由器的结构

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191125145147.png)



路由器是一种具有多个输入端口和输出端口的**专用计算机**。

> 可以直接将电脑改成路由器

路由器的任务是**转发分组**。即将路由器某个端口收到的分组，按照分组要到达的目的网络，将该分组从某个合适的输出端口转发给下一跳路由器。下一跳路由器也按照这种方法处理分组，直到该分组到达目的网络为止。

路由器转发分组是**网络层**的主要工作。

> 交换机mac地址，数据链路层的

整个路由器分为两大部分：**路由选择**和**分组转发**两部分。

路由选择部分也叫控制部分，核心构件是路由选择处理机。路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断的更新和维护路由表。

分组转发部分分为：**交换构件、一组输入端口和一组输出端口。**

> 输入输出是相对的，本次输入下次可能输出

交换构件又叫交换组织，作用是根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。

在路由器的输入输出端口里面都各有三个方框，用方框中的1,2,3分别代表物理层、数据链路层和网络层的处理模块。

物理层进行比特的接收。

数据链路层按链路层协议接收传送分组的帧。

在将帧的首部和尾部剥去后，分组被送入网络层的处理模块。

若接收到的分组是路由器之间交换路由信息的分组，则将分组送交路由选择处理机。若接收到的是数据分组，则按照分组首部中的目的地址查找转发表，根据得出的结果，分组就经过交换构件到达合适的输出端口。

交换结构

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191125145205.png)



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191125145217.png)



输入端口对线路上收到的分组的处理 

数据链路层剥去帧首部和尾部后，将分组送到网络层的队列中排队等待处理。这会产生一定的时延。 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191125145234.png)



交换结构传送过来的分组先进行缓存。数据链路层处理模块将分组加上链路层的首部和尾部，交给物理层后发送到外部线路。 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191125145247.png)





### 4.路由器的工作原理

（1）路由选择

路由选择就是路由器依据目的IP地址的网络地址部分，通过路由选择算法确定一条从源节点到达目的节点的最佳路由。

路由器需要确定它的下一跳路由器的IP地址，即选择到达下一个路由器的路由，再按照选定的下一跳路由器的IP地址，将数据包转发给下一跳路由器。通过这样一跳一跳地沿着选好的路由转发数据分组，最终把分组传送到目的主机。

路由选择的核心就是确定下一跳路由器的IP地址（静态路由、动态路由）。


（2）分组转发

分组转发也称为分组交换，主要完成按照路由选择所指定的路由将数据分组从源节点转发到目的节点。路由器在接收到一个数据分组时，首先查看数据分组头部的目的IP地址字段，根据目的1P地址的网络地址部分（1P地址分为网络部分和主机号部分）去查询路由表。

+ ①如果表中给出的是到达目的网络地址的下一跳路由器的IP地址，则按照路由表给出的路径转发。

+ ②如果目的网络u是与路由器一个端口直接相连的，那么就直接发往该端口。

> 直接给端口1，需要经过端口1，效果是一样的

+ ③如果路由表中没有下一跳路由器地址，也没有找到目的端口，就将数据分组转发给默认路由。

> 比如里面找不到，就给外网口


（3）路由表

| 目的地址  | 子网掩码      | 下一跳地址 |
| --------- | ------------- | ---------- |
| 100.0.0.0 | 255.255.255.0 | 20.0.0.1   |
| 200.0.0.0 | 255.255.255.0 | 30.0.0.1   |
| 0.0.0.0   | 0.0.0.0       | 10.0.0.1   |



### 5.路由器转发IP数据报的流程

(1) 从收到的分组的首部提取目的 IP 地址 D。

(2) 先用各网络的子网掩码和 D 逐比特相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。

(3) 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行(4)。

(4) 对路由表中的每一行的子网掩码和 D 逐比特相“与”，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)。

(5) 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行(6)。

(6) 报告转发分组出错。







## 静态路由与动态路由

```
一个理想的路由算法应一些特点：
算法必须是正确的和完整的。 
算法在计算上应简单。 
算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。 
算法应具有稳定性。 
算法应是公平的。 
算法应是最佳的。 
```



从路由算法的自适应性考虑

静态路由选择策略——即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。 

> 某个ip必须经过哪些结点，安全，相当于专线

动态路由选择策略——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。  

> 根据繁忙程度

1. 静态路由

静态路由是由网络管理员手工配置的路由信息。

静态路由一般适用于比较简单的网络环境，优点是简单、高效、可靠。

> 哪些是固定的

静态路由信息在缺省情况下是私有的，不会传递给其他的路由器。

> traceroute是`**`隐私

静态路由是在路由器中设置的固定的路由表，不能对网络的改变作出反映，需要手工去修改。



配置静态路由步骤：

```
①确定目的网络的地址和掩码，确定下一跳地址或转发数据包的本地接口。
②进入全局配置模式。
③使用ip route 命令添加路由。
④退出全局配置模式。
⑤使用copy running-config startup-config 或wr命令将配置保存到nvram里面。


```



缺省路由

```
缺省路由（也称为默认路由）也是一种特殊的静态路由。
作用是当路由表中不存在到某一目的网络的项目时，路由器使用缺省路由对数据包进行转发。
没有缺省路由，目的地址在路由表中无匹配表项的IP数据报将被丢弃。
缺省路由可有管理员静态地输入或者通过路由选择协议被动态地学到。

有两条不同的命令来静态地配置缺省路由：
“ip router 0.0.0.0  0.0.0.0”
“ip defaultnetwork”
候选缺省路由在路由表中是用星号来标注的，并且被认为是最后的网关。

检查静态路由配置可使用以下命令：
Show running-config
Show ip route
还可以使用命令：
Show interface查看接口的状态
Show ip route 查看路由表
Ping 下一条路由器接口地址
Ping 远端路由器或主机
Traceroute远端路由器或主机


```



2.动态路由

```
大型和复杂的网络环境通常不宜采用静态路由。
一方面，网络管理员难以全面地了解整个网络的拓扑结构；
另一方面，当网络的拓扑结构和链路状态发生变化时，路由器中的静态路由信息需要大范围地调整，这一工作的难度和复杂程度非常高。
动态路由是网络中的路由器之间相互通信，传递路由信息，利用收到的路由信息更新路由器表的过程。
它能实时地适应网络结构的变化。
动态路由适用于网络规模大、网络拓扑复杂的网络。

```



因特网采用分层次的路由选择协议

```
因特网的规模非常大。
许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到因特网上。   

```



自治系统 AS(Autonomous System) 

```
自治系统 AS 的定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。现

在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。

```

因特网有两大类路由选择协议 

```
内部网关协议 IGP (Interior Gateway Protocol)    即在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

外部网关协议EGP (External Gateway Protocol)    若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。  

```





自治系统和内部网关协议、外部网关协议 

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126080732.png)



这里要指出两点 



因特网的早期 RFC 文档中未使用“路由器”而是使用“网关”这一名词。但是在新的 RFC 文档中又使用了“路由器”这一名词。应当把这两个属于当作同义词。

> 网关即路由器

IGP 和 EGP 是协议类别的名称。但 RFC 在使用 EGP 这个名词时出现了一点混乱，因为最早的一个外部网关协议的协议名字正好也是 EGP。因此在遇到名词 EGP 时，应弄清它是指旧的协议 EGP 还是指外部网关协议 EGP 这个类别。   

> TCP是具体协议，tcpip也是协议族



因特网的路由选择协议 

内部网关协议 IGP：具体的协议有多种，如 RIP 和 OSPF 等。

外部网关协议 EGP：目前使用的协议就是 BGP。





路由选择算法常用的度量标准

```
（1）带宽（bandwidth）：链路的数据容量。
（2）延迟（delay）：分组沿着从源到目的的每条链路移动所需的时间。
（3）负载（load）：网络资源的活动量。
（4）可靠性（reliability）：每个网络链路的错误率。
（5）跳数（hop count）：分组到达目的地之前必须经过的路由器个数。
（6）滴答数（ticks）：使用IBM PC时钟滴答计数的数据链路延迟。
（7）代价（cost）：由管理员指派的基于带宽、花费等的度量值。


```



## RIP路由协议

```


```

1.RIP协议概述

路由信息协议( routing information protocol，RIP)是IP网络中使用得最早、应用最广泛的AS内部路由选择协议。

RIP是一种分布式的基于距离向量的路由选择协议，是因特网的标准协议。

在RFC 1058中定义了RIPv1版本， RFC 2453中定义了它的向后兼容版本RIPv2。

RIPv1使用跳数(hop count)作为费用测度，即将每条链路的费用均设为1。 

> 路由器，路口

跳数是沿着从源路由器到目的子网（包括目的子网）的最短路所经过的子网数量，IP数据报每经过一台路由器，跳数就加1。



“距离”的定义

从一个路由器到直接连接的网络的距离定义为 1。

从一个路由器到非直接连接的网络的距离定义为所经过的路由器个数加 1。

RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。
> 路由器个数，即加入第一个路由器

这里的“距离”实际上指的是“最短距离”， （最少的跳数）



RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。

RIP 允许一条路径最多只能包含 15 个路由器。

“距离”的最大值为16 时即相当于不可达。可见 RIP 只适用于小型互联网。

RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。   

> 最少路由优先

RIP 协议的三个要点 

仅和相邻路由器交换信息。 
> 经过什么，可以到达什么


交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 

按固定的时间间隔交换路由信息(如每隔 30 秒)。 



路由表的建立 

路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为1）。
以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
RIP 协议的收敛(convergence)过程较快，即在自治系统中所有的结点都得到正确的路由选择信息的过程。 
> 出错过程较慢，即发现错误信息时



距离向量（Ford-Fulkerson ）算法


收到相邻路由器（其地址为 X）的一个 RIP 报文：

(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。

(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：

若项目中的目的网络不在路由表中，则把该项目添加到路由表中。
    否则
       若下一跳字段给出的路由器地址是同样的，则把收到的项	目	替换原路由表中的项目。
       否则 
           若收到项目中的距离小于路由表中的距离，则进行更新，
	否则，什么也不做。

(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为16（距离为16表示不可达）。

> 则中间隔着一个，要想知道坏了，至少3.5分钟

(4) 返回。







路由器之间交换信息 


RIP协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。

虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。  



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126084140.png)

刚开始加电时的路由表

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126084358.png)

第一次更新路由表

> 下一跳，下一个路由器



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126090439.png)



第二次更新路由表



### RIP2 协议的报文格式

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126090549.png)

RIP2 的报文由首部和路由部分组成。

RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。地址族标识符（又称为地址类别）字段用来标志所使用的地址协议。

路由标记填入自治系统的号码，这是考虑使RIP 有可能收到本自治系统以外的路由选择信息。再后面指出某个网络地址、该网络的子网掩码、下一跳路由器地址以及到此网络的距离。  



### RIP 协议的优缺点

```
RIP 存在的一个问题是当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器。
RIP 协议最大的优点就是实现简单，开销较小。
RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。   

```



### RIPv 1与RIPv2的比较

（1）RIPv1是有类路由(classful)协议，它们在宣告路由信息时不携带网络掩码。RIPv2是无类路由(classless)协议，它们在宣告路由信息时携带网络掩码。

> v1相当于默认掩码B-255.255.0.0

（2）RIPv1是广播发送RIP报文，广播地址为255. 255. 255. 255。RIPv2支持广播也支持多播发送RIP报文，多播地址为224.0.0.9。发送广播是给所有路由器包括网络中的主机，而多播只发送给使用该协议的路由器。与广播相比多播明显节省带宽。

> v1主机会收到报文，V2只有路由器会收到



### RIP路由自环分析

由于RIP距离向量路由选择算法有一个慢收敛问题

路由选择协议更新信息时具有好消息传播得快，而坏消息传播得慢的特点。

这个问题将导致不一致性产生，从而产生路由自环。

> 只有R1最先知道，其他都要加到16才知道



### RIP协议使用以下机制减少路由自环

（1）水平分割。

（2）毒化翻转。

（3）保持定时器法。

（4）触发更新法。



## OSPF路由协议


1. OSPF协议概述

开放最短路径优先（ open shortest path first，OSPF）是另一种广泛应用于因特网AS内部的链路状态路由协议。

使用链路状态路由算法

通常用于区域ISP或本地ISP网络，网络规模可以很大

开放(open) 一词是指路由选择协议规范是公众可免费使用的。最短路径优先是因为使用了公开发表的Dijkstra提出的最短路径算法SPF

RFC 2328，适用于IPv4，OSPFv2

RFC 5340，适用于IPv6，OSPFv3


三个要点 

向本自治系统中所有路由器发送信息，这里使用的方法是洪泛法。

发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。

“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。 
> 度量可以是如发出返回时长

只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。  



链路状态数据库(link-state database) 

由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。

这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的（这称为链路状态数据库的同步）。

OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。OSPF 的更新过程收敛得快是其重要优点。 



OSPF基本特点

（1）支持无类域间路由（CIDR）。

（2）支持区域划分。

（3）无路由自环。

（4）路由变化收敛速度快。

（5）使用IP组播收发协议数据。

（6）支持多条等值路由。

（7）支持协议报文的认证。

> 泛洪相当于是触发的


OSPF的区域划分


为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫作区域。

每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。

区域也不能太大，在一个区域内的路由器最好不超过 200 个。  



OSPF 划分为两种不同的区域 


![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191126093122.png)



划分区域 

划分区域的好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。

> 网3坏了，R8不需要知道



在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。

> 网3想给网8，

OSPF 使用层次结构的区域划分。在上层的区域叫作主干区域(backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。  



































































