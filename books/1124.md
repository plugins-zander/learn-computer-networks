# E-mail服务

## 电子邮件概述

电子邮件（e-mail）是因特网上最典型的服务之一，在因特网中出现最早，应用最普遍、最广泛。

因特网用户中90％以上都使用过电子邮件。电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器进行读取。

这相当于因特网为用户设立了存放邮件的信箱，因此e-mail有时也称为“电子信箱”。

电子邮件方便、快捷、廉价的优点。

1982年，简单邮件传送协议（Simple Mail Transfer Protocol，SMTP）和Internet文本报文格式成为Internet的正式标准。

1993年，通用Internet邮件扩充（Multipurpose Internet  Mail Extensions，MIME）协议在邮件首部中说明了邮件的数据类型（如文本、声音、图像、视频等），使得在MIME邮件可同时传送多种类型的数据。



### 电子邮件系统的组成

电子邮件系统有3个主要组成部分，即用户代理（User Agent，UA）、邮件服务器和简单件传输协议（SMTP）和邮件读取协议（如POP3）。

![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191217093205.png)



用户代理 UA (User Agent)

```
用户代理 UA 就是用户与电子邮件系统的接口，是电子邮件客户端软件。
用户代理的功能：撰写、显示、处理和通信。
邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况（已交付、被拒绝、丢失等）。
邮件服务器按照客户服务器方式工作。邮件服务器需要使用发送和读取两个不同的协议。

```







### 电子邮件的发送和接收过程



![](https://raw.githubusercontent.com/ZanderZhao/images/master/img2019/20191217093456.png)



（1）发信人调用用户代理来编辑要发送的邮件。用户代理用SMTP把邮件传送给发送端邮件服务器。

（2）发送端邮件服务器将邮件放入邮件缓存队列中，等待发送。因为邮件过多，所以需要等待。如果想要避免缓冲溢出导致邮件丢失，发信人可以避开邮件收发高峰期后再发送邮件。

（3）运行在发送端邮件服务器的SMTP客户进程发现在邮件缓存中有待发送的邮件，就向运行在接收端邮件服务器的SMTP服务器进程发STCP连接的建立。

（4）TCP连接建立后，SMTP客户进程开始向远程的SMTP服务器进程发送邮件。当所有的待发送邮件发完了，SMTP就关闭所建立的TCP连接。

（5）运行在接收端邮件服务器中的SMTP服务器进程收到邮件后，将邮件放入收信人的用户邮箱中，等待收信人在方便时进行读取。

（6）收信人在打算收信时，调用用户代理，使用POP3（或IMAP）协议将自己的邮件从接收端邮件服务器的用户邮箱中取回（如果邮箱中有来信的话）。







### 电子邮件的组成



标准的电子邮件信息由两部分组成：邮件头（header）邮件体（body）

+ 邮件头相当于“信封”，主要包括收件人地址、投递日期、邮件主题、发件人地址。
+ 邮件体就是邮件正文、内容，相当于装在信封内的信。

邮件头中的一些主要关键词

- RFC 822只规定了邮件内容中的首部（header）格式，而对邮件的主体（body）部分则让用户自由撰写。
- Received：接收邮件的路径、日期、时间以及邮件代理程序的版本号。
- From：表示邮件发送者，包括邮件地址和发送方的“真实姓名”。
- Date：发信时间。
- Message-ID：由传输代理分配给该邮件的唯一标识。
- To：收件人的电子邮件地址。
- Subject：邮件主题，是发件人写的，告诉收件人该邮件的目的。
- Content-type：邮件正文的类型，是文本还是MIME格式。
- Cc：表示抄送，它是“Carbon copy”的缩写，意为“复写副本”，它用来指定那些将收到该邮件副本的人的邮件地址。

电子邮件地址的格式

+ TCP/IP 体系的电子邮件系统规定电子邮件地址的格式如下：  

+ 收件人邮箱名@邮箱所在主机的域名

+ > 符号“@”读作“at”，表示“在”的意思。  
  >
  > 例如，电子邮件地址 abc@163.com,
  >
  > abc这个用户名在该域名的范围内是唯一的。
  >
  > 163.com邮箱所在的主机的域名在全世界必须是唯一的  



## 电子邮件相关协议

### 简单邮件传输协议

- SMTP是因特网上通用的电子邮件传输协议。它的特点是简单明了，容易实现。SMTP定义了邮件格式及如何通过TCP连接传输邮件。SMTP使用25号端口在两个邮件服务器之间建立TCP连接。

- SMTP协议由两个文档进行描述：

- RFC821：描述了邮件服务器之间如何转发邮件；

- RFC822：定义邮件信息的格式。

- SMTP规定邮件的全部内容（包括附件），无论是什么类型的数据都必须转换成7位ASCII码进行传输。

- SMTP所规定的就是在两个相互通信的SMTP进程之间应如何交换信息。由于SMTP使用客户/服务器方式，因此负责发送邮件的SMTP进程就是SIVITP客户，而负责接收邮件的SMTP进程就是SMTP服务器。

- SMTP规定了1 4条命令和2 1种应答信息。每一条命令由4个字母组成。每一种应答    信息SMTP有一行信息，由一个3位数字的代码开始，后面可以附上很简单的文字说明。

- SMTP定义了几个非常简单的命令用来进行邮件的发送，其中包括：HELO、MAIL FROM、RCPT TO、DATA、QUIT。

- SMTP通信的3个阶段如下：

  - （1）连接建立。连接是在发送主机的SMTP客户和接收主机的SMTP服务器之间建立的。SMTP不使用中间的邮件服务器。
  - （2）邮件传送。
  - （3）连接释放。邮件发送完毕后，SMTP应释放TCP连接。

- 一个用Telnet进行SMTP协议对话的例子

  ![img](https://mubu.com/document_image/ce11560b-7046-42ae-a144-1d09076f5d12-4644403.jpg)





### 邮件读取协议POP3和IMAP

- 邮局协议 POP 是一个非常简单、但功能有限的邮件读取协议，现在使用的是它的第三个版本 POP3。
- POP 也使用客户服务器的工作方式。
- 在接收邮件的用户 PC 机中必须运行 POP 客户程序，而在用户所连接的 ISP 的邮件服务器中则运行 POP 服务器程序。
- 互联网信息获取协议(Internet Message Access Protocol，IMAP)也按客户/服务器方式工作，现在较新的版本是IMAP4。
- 用户在自己的 PC 机上就可以操纵 ISP 的邮件服务器的邮箱，就像在本地操纵一样。
- 因此 IMAP 是一个联机协议。当用户 PC 机上的 IMAP 客户程序打开 IMAP 服务器的邮箱时，用户就可看到邮件的首部。若用户需要打开某个邮件，则该邮件才传到用户的计算机上。
- IMAP 的特点
  - IMAP最大的好处就是用户可以在不同的地方使用不同的计算机随时上网阅读和处理自己的邮件。
  - IMAP 还允许收件人只读取邮件中的某一个部分。例如，收到了一个带有视像附件（此文件可能很大）的邮件。为了节省时间，可以先下载邮件的正文部分，待以后有时间再读取或下载这个很长的附件。
  - IMAP 的缺点是如果用户没有将邮件复制到自己的 PC 机上，则邮件一直是存放在 IMAP 服务器上。因此用户需要经常与 IMAP 服务器建立连接。

### 通用Internet电子邮件扩充协议

- 通用Internet电子邮件扩充协议（MIME）也称为多用途互联网邮件扩展类型（RFC 2045 ～2049

- 设定某种扩展名的文件用一种应用程序来打开，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。

- MIME多用于指定一些客户端白定义的文件以及一些媒体文件的打开方式。

- MIME概述

  - 由于SMTP有以下缺点

    - （1）SMTP不能传送可执行文件或其他二进制对象。
    - （2）SMTP限于传送7位的ASCII码。许多其他非英语国冢的文字（如中文或俄文，甚至带重音符号的法文或德文）就无法传送。
    - （3）SMTP服务器会拒绝超过一定长度的邮件。
    - （4）某些SMTP的实现并没有完全按照RFC 821的SMTP标准。

  - MIME并没有改动或取代SMTP。

  - MIME的意图是继续使用目前的RFC 822格式，但增加了邮件主体的结构，并定义了传送非ASCII码的编码规则。

  - MIME很好地兼容并扩展了SMTP。

  - MIME 和 SMTP 的关系 

    - 

      ![img](https://mubu.com/document_image/baea204b-b1d7-485c-a5c4-e8b93321e58f-4644403.jpg)

  - MIME主要包括3个部分

    - （1）5个新的邮件首部字段，它们可包含在RFC 822首部中。这些字段提供了有关邮件主体的信息。
      - MIME增加5个新的邮件首部
        - （1）MIIVIE-Version：标志MIME的版本。现在的版本号是1.0。若无此行，则为英文文本。
        - （2）Content-Description：是可读字符串，说明此邮件是什么，和邮件的主题差不多。
        - （3）Content-Id：邮件的唯一标识符。
        - （4）Content-Transfer-Encoding：说明在传送时邮件的主体是如何编码的。
        - （5）Content-Type:说明邮件的性质。
    - （2）定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化。
    - （3）定义了传送编码，可对任何内容格式进行转换，而不会被邮件系统改变。

- MIME内容类型

  - MIME中标准规定Content-Type说明必须含有两个标识符，即内容类型(type)和子类型( subtype)，中间用“／”分开。
  - MIME 标准定义了 7 个基本内容类型和 15 种子类型。
    - Content-Type有下面几种常见的类型：
    - Text：用于标准化地表示的文本信息，文本消息可以是多种字符集和或者多种格式的；
    - Multipart：用于连接消息体的多个部分构成一个消息，这些部分可以是不同类型的数据；
    - Application：用于传输应用程序数据或者二进制数据；
    - Message：用于包装一个E-mail消息；
    - Image：用于传输静态图片数据；
    - Audio：用于传输音频或者音声数据；
    - Video：用于传输动态影像数据，可以是与音频编辑在一起的视频数据格式。
    - subtype用于指定type的详细形式。
    - content-type/subtype配对的集合和与此相关的参数，将随着时间而增长。

- MIME内容传送编码

  - 最简单的编码就是 7 位 ASCII 码，而每行不能超过 1000 个字符。MIME 对这种由 ASCII 码构成的邮件主体不进行任何转换。
  - 另一种编码称为 quoted-printable，这种编码方法适用于当所传送的数据中只有少量的非 ASCII 码。
  - 对于任意的二进制文件，可用 base64 编码。



