# 无类别域间路由地址（CIDR）

## 因特网发展面临的必须尽早解决的问题

- B类地址在1992年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕
- 因特网主干网的路由表项目数量急剧增长（从几千个增长到几万个）。
- 整个 IPv4 的地址空间最终将全部耗尽

## 无分类编址CIDR的出现

- 在RFC1009变长子网掩码 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择CIDR (Classless Inter-Domain Routing)。
- 1993年，RFC1517～1519、1520。

## CIDR地址的特点

- CIDR地址不分类

  - CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

  - CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。

  - IP 地址从三级编址（使用子网掩码）又回到了两级编址。

    - 

      ![img](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200115191624.png)

  - CIDR 还使用“斜线记法”(slash notation)，即CIDR记法，表示IP地址中网络前缀的长度，如128.15.48.34/20。


## CIDR地址块

- CIDR 将网络前缀都相同的连续的 IP 地址组成“CIDR地址块”。

- 一个CIDR地址块由地址块的起始地址和地址块中的地址数来定义。

- CIDR地址块举例

  - CIDR地址块128.15.48.0/20，则：

    - 地址块的起始地址： 128.15.48.0；
    - 地址块中共有 212个地址；
    - 地址块中的最小地址：128.15.48.0；
    - 地址块中的最大地址：128.15.63.255；

  - 地址块中全 0 和全 1 的主机号地址一般作为特殊地址使用，通常只使用在这两个地址之间的地址；

  - 地址块的长度也可以用子网掩码来表示；

  - CIDR地址块128.15.48.0/20的结构

    ![img](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200115191625.png)

## CIDR地址块的应用

- 网络192.168.1.0和4个子网的IP地址范围

  ![img](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200115191626.png)

  - 根据表5-9及CIDR地址块的定义，可以将网络192.168.1.0和4个子网表示成CIDR地址块的形式

    - 网络：192.168.1.0/24
    - 子网0：192.168.1.0/26
    - 子网1：192.168.1.64/26
    - 子网2：192.168.1.128/26
    - 子网3：192.168.1.192/26

  - 大小CIDR地址块之间的变化关系

    

    ![img](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200115191627.png)


## CIDR地址块的应用举例

- 【例5-4】

  - 有4个/24地址块：212.56.132.0/24，212.56.133.0/24，212.56.134.0/24，212.56.135.0/24。请试着进行最大可能的聚合。

  - 分析

    - 将4个地址块的前缀都转换为二进制，看是否有相同的网络前缀存在。

      ![img](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20200115191628.png)

- 【例5-5】

  - 有两个CIDR地址块208.128/11和208.130.28/22。是否有哪一个地址块包含了另一个地址？如果有，请指出，并说明理由
  - 分析：地址块208.128/11的前缀为：11010000100
  - 地址块208.130.28/22的前缀为：11010000100 00010 000111
  - 可以看出它的前11位与208.128/11的前缀是一致的，所以208.128/11地址块包含了208.130.28/22这一地址块。

- 【例5-6】

  - 假定某ISP已拥有一个地址块202.240.64.0/18。现在某大学需要1000个IP地址。ISP给该大学分配的地址块为202.240.68.0/22。这个大学有4个学院，其中计算机学院有主机500台，信息工程学院有主机252台，理学院有主机124台，法学院有主机124台。请试着为这4个学院分配地址块，并列出各个学院拥有的地址数及占用地址空间比例。

  - 分析：ISP拥有的地址块202.240.64.0/18相当于64个C类网络的地址空间（24-18=6，$2^6$=64）。现在大学需要1000个IP地址。ISP给大学分配的地址块为202.240.68.0/22，它包括1024个IP地址（32-22=10，$2^{10}$=1024），相当于4个连续的C类网络（24-22=2，$2^2$=4），占该ISP拥有的地址空间的1/16。

  - 根据4个学院拥有的主机数量给4个学院分配的地址块分别为：

    - 计算机学院202.240.68.0/23，因为500台主机<512=$2^9$，32-9=23；
    - 信息工程学院202.240.70.0/24，因为252台主机<256=$2^8$，32-8=24；
    - 理学院202.240.71.0/25，因为124台主机<128=$2^7$，32-7=25；
    - 法学院202.240.71.128/25

  - ISP及大学地址块的分析结果

    - 地址块

    ![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191223152559.png)

    - 大学及各个学院拥有的地址数及地址空间比例

      | 单位         | 地址块            | 二进制表示                    | 地址数 | 地址空间比例 |
      | ------------ | ----------------- | ----------------------------- | ------ | ------------ |
      | ISP          | 202.240.64.0/18   | 11001110.00000000.01*         | 16384  |              |
      | 大学         | 202.240.68.0/22   | 11001110.00000000.010001*     | 1024   | 占ISP1/16    |
      | 计算机学院   | 202.240.68.0/23   | 11001110.00000000.0100010*    | 512    | 占大学50%    |
      | 信息工程学院 | 202.240.70.0/24   | 11001110.00000000.01000110.*  | 256    | 占大学25%    |
      | 理学院       | 202.240.71.0/25   | 11001110.00000000.01000111.0* | 128    | 占大学12.5%  |
      | 法学院       | 202.240.71.128/25 | 11001110.00000000.01000111.1* | 128    | 占大学12.5%  |

## 地址聚合的概念

这个ISP共拥有64个C类网络。如果不采用CIDR技术，则在与该ISP的路由器交换路由信息的每一个路由器的路由表中，就需要有64个项目。

采用地址聚合后，只需要用路由聚合后的一个项目202.240.64.0/18就能找到该ISP。

同理，在ISP的路由器的路由表中，也只需要使用202.240.68.0/22这一个项目就能找到该大学。

这个大学共有4个学院，在大学的路由器的路由表中，只需要包含指向4个学院的路由信息就可以了。

## 路由聚合(route aggregation)

由于一个CIDR地址块中有很多地址，所以在路由表中可以利用CIDR地址块来表示目的网络。

这种地址聚合也称为路由聚合(route aggregation)，它使得路由表中的一个项目可以表示原来传统分类地址的很多个路由。

路由聚合也称为构成超网(super netting)。

路由聚合有利于减少路由器之间路由选择信息的交换，从而提高了整个因特网的性能。



## 最长前缀匹配

使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。

在查找路由表时可能会得到不止一个匹配结果。 

应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配(longest-prefix matching)。

网络前缀越长，其地址块就越小，因而路由就越具体(more specific) 。

最长前缀匹配又称为最长匹配或最佳匹配。    

```
最长前缀匹配举例

收到的分组的目的地址 D = 202.240.71.128

路由表中的项目：202.240.68.0/22        （ISP）
               202.240.71.128/25    （法学院）


查找路由表中的第 1 个项目
第 1 个项目 202.240.68.0/22 的掩码 M 有 22 个连续的 1。
M = 11111111 11111111 11111100 00000000
因此只需把 D 的第 3 个字节转换成二进制。
         M = 11111111 11111111 11111100 00000000
AND      D = 202.     240.     01000100.       0
             202.     240.     01000100.       0 
与 202.240.68.0/22 匹配

再查找路由表中的第 2 个项目
第2个项目 202.240.71.128/25 的掩码M有 25 个连续的1。
M = 11111111 11111111 11111111 10000000
因此只需把 D 的第 4 个字节转换成二进制。
         M = 11111111 11111111 11111111 10000000
AND      D = 202.     240.     71.      10000000
             202.     240.     71.      10000000
与 202.240.71.128/25 匹配



D AND (11111111 11111111 11111100 00000000)
          = 202.240.68.0/22          匹配
D AND (11111111 11111111 11111111 10000000)
         = 202.240.71.128/25         匹配
选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。 

```





