# ICMP协议

## 概述

为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

ICMP 不是高层协议，而是 IP 层的协议。

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。 

## ICMP报文

### ICMP报文的种类

ICMP 报文的种类有两种，即 ICMP 差错报告报文和 ICMP 询问报文。 

ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。

接着的 4 个字节的内容与 ICMP 的类型有关。 

### ICMP 报文的格式

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112113041.png)



### 类型字段及代码字段的值与ICMP报文类型的对应关系

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112113447.png)



#### ICMP差错报告报文共有五种

+ （1）终点不可达：路由器或主机不能交付数据报时，就向源站发送目的站不可达报文。
+ （2）源站抑制：路由器或主机由于拥塞而丢弃数据报时，就向源站发送源站抑制报文，使源站知道应当放慢速率。
+ （3）时间超时：路由器收到生存时间为零的数据报时，除丢弃数据报外，还要向源站发送时间超时报文。   
+ （4）参数问题：路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源站发送参数问题报文。
+ （5）改变路由：路由器将改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112113527.png)



​	不应发送 ICMP 差错报告报文的几种情况

对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。

对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。

对具有多播地址的数据报都不发送 ICMP 差错报告报文。

对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。

#### ICMP 询问报文有两种

回送请求和回答报文时

间戳请求和回答报文

​          下面的几种 ICMP 报文不再使用

信息请求与回答报文

掩码地址请求和回答报文

路由器询问和通告报文 





## ICMP的应用举例

- 连通性测试程序ping
  - PING 用来测试两个主机之间的连通性。
  - PING 使用了 ICMP 回送请求与回送回答报文。
  - PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。
  - Windows系统的用户的用户可在接入因特网后转入MS-DOS（点击“开始”，点击“运行”，再输入“ cmd ”）。看见屏幕上的提示符后，就键入“ping hostname” (这里的hostname是要测试连通性的主机名或它的IP地址)，按回车键后就可看到结果
- 路径追踪程序traceroute
  - traceroute程序是ICMP的另一种非常有用的应用。
  - 该程序允许跟踪从一个主机或一台路由器到世界上其他任意一个主机或路由器之间的路由。
  - 为了判断源主机和目的主机之间所有路由器的数量和标识（名字和IP地址），源主机中的traceroute向目的主机发送ICMP报文序列。这些报文关键在于IP数据报的TTL字段中进行特殊设置。













