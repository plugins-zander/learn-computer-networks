# ARP协议

## ARP协议工作原理

### 概述

因特网中的每个主机都具有一个唯一的IP地址，但**IP地址只是一种在网络层标识主机的逻辑地址**，**不能直接利用它们在一个物理网络中传输。**

> 意思就是，我们逻辑上可以通过分ip实现规划，但是真正传内容时，还是要找ip
>
> ARP是将ip转mac

只有将IP数据报封装在物理网络的数据链路层的数据帧中，才能实现IP数据报在物理网络中的传输。

为了在物理上实现IP分组的传输，需要网络层提供从主机IP地址到主机MAC地址的映射功能。

地址解析协议（Address Resolution Protocol ，ARP）正是实现这种功能的协议。

### 源主机和目的主机位于同一个网络

当网络层产生IP数据报时，源主机可以得知自己的IP地址和MAC地址以及目的主机的IP地址，但却不知道目的主机的MAC地址。只有获得目的主机的MAC地址，位于相同网络的两个主机才能直接进行物理通信。每个主机都有一个称为ARP表(ARP table)的高速缓存，存储网络中所有主机和路由器接口的IP地址与MAC地址的映射信息

| Internet地址 | 物理地址          | 地址类型 | TTL      |
| ------------ | ----------------- | -------- | -------- |
| 192.168.10.1 | aa-aa-aa-aa-aa-aa | 动态     | 01:31:00 |
| 192.168.10.2 | bb-bb-bb-bb-bb-bb | 静态     | 01:32:00 |

当主机A欲向本局域网上的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无主机B的IP地址。

+ 如 有，就可查出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址。
+ 如果查不到主机B的IP地址的项目，主机A就自动运行ARP协议，然后按以下步骤找到主机B的硬件地址。
+ （1）ARP在网内广播一个ARP请求分组。 ARP请求分组的内容是：“我的IP地址是192.168. 10. 1，MAC地址是aa-aa-aa-aa-aa-aa。我需要知道IP地址为192.168.10.2的主机的硬件地址”。这对应于图5-39中的步骤①。
+ （2）网络中所有运行ARP进程的主机都会收到此ARP请求分组。
+ （3）主机B发现ARP请求分组中的目的地址是自己的IP地址，就以单播方式向主机A发送ARP响应分组，并写入自己的MAC地址。而其他所有主机都不会响应这个ARP请求分组。ARP响应分组的主要内容是：“我的IP地址是192.168. 10. 2，MAC地址是bb-bb-bb-bb-bb-bb”。这对应于图5-39中的步骤②。
+ （4）主机A在收到主机B的ARP响应分组后，就会在自己的ARP表中写入主机B的IP地址到MAC地址的映射。至此，一次ARP交互过程结束。

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112085133.png)









#### ARP 高速缓存的作用

当主机A不久后再向主机B发送数据报时，会发现其ARP表中存在主机B的IP地址与MAC地址的映射项目，因此无需再经过上面的ARP过程了。

**为了减少网络上的通信量**，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。

当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这样主机 B 以后向 A 发送数据报时就更方便了。 



```bash
“arp -a"就可以查看ARP缓存中的内容
用“arp -d"命令可以删除ARP缓存中所有的内容。
用“arp -s"命令可以在ARP缓存中添加IP地址与MAC地址的映射关系，类型为static（静态）

 zander@zander-PC  ~/Desktop  arp -a
OpenWrt.lan (172.16.0.2) at 00:0c:29:e0:8e:bc [ether] on wlp0s20f3
? (172.16.0.1) at 00:1a:a9:15:2b:01 [ether] on wlp0s20f3
? (172.16.1.0) at d8:c8:e9:b2:d0:fd [ether] on wlp0s20f3

```



#### 为什么我们不直接使用硬件地址进行通信？

> 是可行的，但是特别麻烦，所以不用
>
> 交换机不可能记住所有无规则的mac（厂商有规律，但是没用）

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

连接到因特网的主机都拥有统一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为调用 ARP 来寻找某个路由器或主机的硬件地址都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。  





### 源主机和目的主机位于不同网络

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112083512.png)



（1）主机A用网络1的网络地址192.168. 10. 0/24与目的主机D所在网络2的网络地址192.168.20. 0/24进行比较，发现它们**不在同一个子网**。因此，主机A与主机D的通信是间接交付过程。

主机A首先要将IP数据报转发给本网络的默认网关（一般情况下是交换机接口，发给谁，经过谁中转，即图5-41中路由器R连接网络1的接口，必须同一子网，默认网关不一定前三段一样，子网掩码作用），为此它首先要确定默认网关的MAC地址。由于主机A通常配置有默认网关的IP地址，因此它通过运行ARP就能获得默认网关的MAC地址00-00-00-00-00-00，这对应于图5-41中的步骤①。

（2）主机A与默认网关之间进行数据帧的传送。这对应于图5-41中的步骤②。

（3）网络1上的路由器收到链路层数据帧后，向上传递给路由器的网络层。此时，路由器利用其路由转发功能确定转发该数据报的正确接口。路由器通过查询转发表让该数据报通过路由器接口192.168.20.1转发，这对应于图5-41中的步骤③

（4）路由器接口192.168.20.1将目的主机的IP地址与网络2的网络地址进行比较，发现两者位于同一个子网，可以采用直接交付方式传输数据报。这对应图5-41中的步骤④。路由器接口192.168.20.1运行ARP，通过主机D的IP地址得到其MAC地址dd-dd-dd-dd-dd-dd。

（5）路由器接口192.168.20.1的适配器向主机D的适配器传输数据帧。这对应于图5-41中的步骤⑤。至此完成了两个位于不同网络的主机之间传送数据报的过程。如果源主机和目的主机之间有多个路由器，则可能多次重复上述步骤③。



### 使用 ARP 的四种典型情况

发送方是主机，要把IP数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。 

发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。 

发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 







## ARP报文格式

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112090333.png)

（1）硬件类型：16比特，指明了发送方想知道的硬件接口类型，以太网的值为1；

（2）协议类型：16比特，指明了发送方提供的高层协议类型，IP为0X0800（16进制）；

（3）硬件地址长度：8比特，指明了每种硬件地址的字节长度，对于MAC地址长度，此处的值为6；

（4）协议长度：8比特，指明了高层协议地址的长度，对于IP地址长度，此处值为4。这样ARP报文就可以在任意硬件和任意协议的网络中使用；

（5）操作类型：16比特，用来表示这个报文的类型，ARP请求为1，ARP响应为2，RARP请求为3，RARP响应为4；

（6）发送方硬件地址（0-3字节）：源主机硬件地址的前4个字节；

（7）发送方硬件地址（4-5字节）：源主机硬件地址的后2个字节；

（8）发送方IP地址（0-1字节）：源主机IP地址的前2个字节；

（9）发送方IP地址（2-3字节）：源主机IP地址的后2个字节；

（10）目标硬件地址（0-1字节）：目的主机硬件地址的前2个字节；

（11）目标硬件地址（2-5字节）：目的主机硬件地址的后4个字节；

（12）目标IP地址（0-3字节）：目的主机的IP地址。







## IP数据报的转发过程



### 直接交付和间接交付

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112110742.png)



（1）直接交付：发送数据报接口的IP地址与目的主机IP地址在同一个网络中时，也就是发送端接口IP地址和子网掩码按位“与”操作的结果等于目的主机的IP地址和子网掩码按位“与”操作的结果。则发送端接口直接将IP数据报发送到目的主机。

（2）间接交付：发送数据报接口IP地址与目的IP地址不在同一个网络中，则发送端接口需要发送IP数据报到与下一个路由器相连的端口。在数据报间接交付过程中，在同一个网络内使用物理地址（MAC地址）转发，只有通过路由器在不同网络中转发时才使用IP地址。



### IP数据报转发过程

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112110839.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112111416.png)



![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112111502.png)

![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112111544.png)





![](https://cdn.jsdelivr.net/gh/ZanderZhao/img20/file/20191112112230.png)

+ 在 IP 层抽象的互联网上只能看到 IP 数据报图中的  $IP_1→IP_2$  表示从源地址$IP_1$  到目的地址 $IP_2$ 两个路由器的 IP 地址并不出现在 IP 数据报的首部中 
+ 路由器只根据目的站的 IP 地址的网络号进行路由选择 
+ 在具体的物理网络的链路层只能看见 MAC 帧而看不见 IP 数据报 
+ IP层抽象的互联网屏蔽了下层很复杂的细节,在抽象的网络层上讨论问题，就能够使用,统一的、抽象的 IP 地址,研究主机和主机或主机和路由器之间的通信 



### IP地址和MAC地址在不同层次、不同区间的变化

| 链路区间 | 网络层IP数据报首部中的IP地址 | 网络层IP数据报首部中的IP地址 | 数据链路层MAC帧首部中的MAC地址 | 数据链路层MAC帧首部中的MAC地址 |
| -------- | ---------------------------- | ---------------------------- | ------------------------------ | ------------------------------ |
|          | 源地址                       | 目的地址                     | 源地址                         | 目的地址                       |
| PC1→R1   | IP1                          | IP2                          | HA1                            | HA3                            |
| R1→R2    | IP1                          | IP2                          | HA4                            | HA5                            |
| R2→PC2   | IP1                          | IP2                          | HA6                            | HA2                            |































